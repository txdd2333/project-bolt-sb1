# 双引擎可视化指南

## 🎨 架构可视化

### 整体架构图

```
╔═══════════════════════════════════════════════════════════════╗
║                    运维工作流中心应用                          ║
║                  (一套代码，双引擎支持)                        ║
╚═══════════════════════════════════════════════════════════════╝
                              │
                              │
        ┌─────────────────────┴─────────────────────┐
        │        VITE_SERVICE_PROVIDER               │
        │         (环境变量控制)                      │
        └─────────────────────┬─────────────────────┘
                              │
                ┌─────────────┴─────────────┐
                │                           │
      ┌─────────▼─────────┐       ┌────────▼────────┐
      │   supabase        │       │     custom      │
      └─────────┬─────────┘       └────────┬────────┘
                │                          │
   ┌────────────▼────────────┐  ┌─────────▼──────────┐
   │   Supabase 引擎          │  │   Custom 引擎       │
   ├─────────────────────────┤  ├────────────────────┤
   │ • SupabaseAuthService   │  │ • CustomAuthService │
   │ • SupabaseDataService   │  │ • CustomDataService │
   │ • SupabaseStorageService│  │ • CustomStorageService│
   └────────────┬────────────┘  └─────────┬──────────┘
                │                         │
   ┌────────────▼────────────┐  ┌─────────▼──────────┐
   │   Supabase Cloud        │  │  Express API       │
   │   ┌──────────────────┐  │  │  Server            │
   │   │  PostgreSQL      │  │  │  (api-server.ts)   │
   │   └──────────────────┘  │  └─────────┬──────────┘
   │   ┌──────────────────┐  │            │
   │   │  Auth Service    │  │  ┌─────────▼──────────┐
   │   └──────────────────┘  │  │ MySQL/OceanBase    │
   │   ┌──────────────────┐  │  │ Database           │
   │   │  Storage Bucket  │  │  └────────────────────┘
   │   └──────────────────┘  │
   └─────────────────────────┘
         (云端托管)                  (本地/私有云)
```

---

## 🔄 切换流程图

### Supabase 模式

```
┌─────────────────────────────────────────────┐
│  1. 配置切换                                 │
│  bash switch-to-supabase.sh                 │
└─────────────┬───────────────────────────────┘
              │
              ▼
┌─────────────────────────────────────────────┐
│  2. .env 更新                                │
│  VITE_SERVICE_PROVIDER=supabase             │
└─────────────┬───────────────────────────────┘
              │
              ▼
┌─────────────────────────────────────────────┐
│  3. 启动前端                                 │
│  npm run dev                                │
│  (无需启动 API 服务器)                       │
└─────────────┬───────────────────────────────┘
              │
              ▼
┌─────────────────────────────────────────────┐
│  4. ServiceFactory 自动选择                  │
│  → SupabaseAuthService                      │
│  → SupabaseDataService                      │
│  → SupabaseStorageService                   │
└─────────────┬───────────────────────────────┘
              │
              ▼
┌─────────────────────────────────────────────┐
│  5. 连接 Supabase Cloud                      │
│  → PostgreSQL 数据库                         │
│  → 云端存储                                  │
│  → 实时订阅                                  │
└─────────────────────────────────────────────┘
```

---

### MySQL/OceanBase 模式

```
┌─────────────────────────────────────────────┐
│  1. 配置切换                                 │
│  bash switch-to-mysql.sh                    │
└─────────────┬───────────────────────────────┘
              │
              ▼
┌─────────────────────────────────────────────┐
│  2. .env 更新                                │
│  VITE_SERVICE_PROVIDER=custom               │
└─────────────┬───────────────────────────────┘
              │
              ▼
┌─────────────────────────────────────────────┐
│  3. 启动 API 服务器（必需）                  │
│  npm run server                             │
│  (监听端口 3000)                             │
└─────────────┬───────────────────────────────┘
              │
              ▼
┌─────────────────────────────────────────────┐
│  4. 启动前端                                 │
│  npm run dev                                │
└─────────────┬───────────────────────────────┘
              │
              ▼
┌─────────────────────────────────────────────┐
│  5. ServiceFactory 自动选择                  │
│  → CustomAuthService                        │
│  → CustomDataService                        │
│  → CustomStorageService                     │
└─────────────┬───────────────────────────────┘
              │
              ▼
┌─────────────────────────────────────────────┐
│  6. 调用 Express API                         │
│  http://localhost:3000/api/*                │
└─────────────┬───────────────────────────────┘
              │
              ▼
┌─────────────────────────────────────────────┐
│  7. 连接数据库                               │
│  → MySQL/OceanBase                          │
│  → 本地文件系统                              │
└─────────────────────────────────────────────┘
```

---

## 📊 数据流图

### 用户登录流程对比

#### Supabase 模式

```
用户输入邮箱密码
      ↓
LoginPage 组件
      ↓
authService.signIn()
      ↓
ServiceFactory.getAuthService()
      ↓
SupabaseAuthService.signIn()
      ↓
supabase.auth.signInWithPassword()
      ↓ HTTPS
Supabase Auth API
      ↓
验证密码哈希
      ↓
生成 JWT Token
      ↓
返回 Session
      ↓
存储到 localStorage
      ↓
页面跳转到首页
```

---

#### Custom 模式

```
用户输入邮箱密码
      ↓
LoginPage 组件
      ↓
authService.signIn()
      ↓
ServiceFactory.getAuthService()
      ↓
CustomAuthService.signIn()
      ↓
fetch('http://localhost:3000/api/auth/login')
      ↓ HTTP
Express API Server
      ↓
查询 MySQL: SELECT * FROM users WHERE email = ?
      ↓
bcrypt.compare(password, hash)
      ↓
jwt.sign({ userId }, JWT_SECRET)
      ↓
返回 { session, user }
      ↓
存储到 localStorage
      ↓
页面跳转到首页
```

---

## 🎯 决策树

### 选择哪个引擎？

```
开始
  │
  ├─ 需要快速开发？
  │  ├─ 是 → Supabase ✅
  │  └─ 否 ↓
  │
  ├─ 需要多人协作？
  │  ├─ 是 → Supabase ✅
  │  └─ 否 ↓
  │
  ├─ 有外网访问？
  │  ├─ 否 → Custom ✅
  │  └─ 是 ↓
  │
  ├─ 数据敏感？
  │  ├─ 是 → Custom ✅
  │  └─ 否 ↓
  │
  ├─ 在生产环境？
  │  ├─ 是 → Custom ✅
  │  └─ 否 → Supabase ✅
```

---

## 📈 性能对比图

### API 响应时间

```
Supabase（云端）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 100-150ms
■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■

Custom（局域网）
━━━━━ 3-10ms
■■■■■

Custom（内网跨机房）
━━━━━━━━━━━━━━ 20-50ms
■■■■■■■■■■■■■■

0ms        50ms       100ms      150ms      200ms
└──────────┴──────────┴──────────┴──────────┘
```

### 并发支持

```
Supabase
连接池: ∞ (自动扩展)
QPS: 1000+ (取决于套餐)
并发: 无限制

Custom
连接池: 10 (可配置)
QPS: 500+ (取决于硬件)
并发: 受服务器限制
```

---

## 🗂️ 文件组织结构

```
项目根目录/
│
├── 📁 src/
│   ├── 📁 services/
│   │   ├── 📄 ServiceFactory.ts          # 服务工厂（核心）
│   │   ├── 📁 auth/
│   │   │   ├── 📄 IAuthService.ts        # 认证接口
│   │   │   ├── 📄 SupabaseAuthService.ts # Supabase 实现
│   │   │   └── 📄 CustomAuthService.ts   # Custom 实现
│   │   ├── 📁 data/
│   │   │   ├── 📄 IDataService.ts        # 数据接口
│   │   │   ├── 📄 SupabaseDataService.ts # Supabase 实现
│   │   │   └── 📄 CustomDataService.ts   # Custom 实现
│   │   └── 📁 storage/
│   │       ├── 📄 IStorageService.ts     # 存储接口
│   │       ├── 📄 SupabaseStorageService.ts
│   │       └── 📄 CustomStorageService.ts
│   └── ...
│
├── 📁 server/
│   ├── 📄 api-server.ts                  # Express API（Custom 引擎）
│   └── ...
│
├── 📁 配置文件
│   ├── 📄 .env                           # 当前配置
│   ├── 📄 .env.example                   # 配置模板
│   ├── 📄 .env.supabase                  # Supabase 预设
│   └── 📄 .env.mysql                     # MySQL 预设
│
├── 📁 切换脚本
│   ├── 📄 switch-to-supabase.sh
│   ├── 📄 switch-to-mysql.sh
│   ├── 📄 switch-to-supabase.bat
│   └── 📄 switch-to-mysql.bat
│
└── 📁 文档
    ├── 📄 QUICKSTART_DUAL_ENGINE.md      # 快速上手 ⭐
    ├── 📄 DUAL_ENGINE_GUIDE.md           # 完整指南 ⭐
    ├── 📄 DUAL_ENGINE_QUICK_REF.md       # 速查表
    ├── 📄 ARCHITECTURE_DUAL_ENGINE.md    # 架构详解
    ├── 📄 SUMMARY_DUAL_ENGINE_SETUP.md   # 配置总结
    └── 📄 DUAL_ENGINE_VISUAL_GUIDE.md    # 本文档
```

---

## 🔐 安全模型对比

### Supabase 安全模型

```
┌─────────────────────────────────────────┐
│  客户端 (浏览器)                         │
│  ├─ Supabase Anon Key (公开)            │
│  └─ User JWT Token (登录后)             │
└─────────────┬───────────────────────────┘
              │ HTTPS
              ▼
┌─────────────────────────────────────────┐
│  Supabase API Gateway                   │
│  ├─ 验证 API Key                        │
│  └─ 解析 JWT Token                      │
└─────────────┬───────────────────────────┘
              │
              ▼
┌─────────────────────────────────────────┐
│  PostgreSQL + RLS                       │
│  ├─ Row Level Security 策略             │
│  ├─ 自动过滤数据                        │
│  └─ auth.uid() = user_id               │
└─────────────────────────────────────────┘
```

**特点**：
- Anon Key 可以公开（权限受限）
- RLS 自动保护数据
- 无法绕过安全策略

---

### Custom 安全模型

```
┌─────────────────────────────────────────┐
│  客户端 (浏览器)                         │
│  └─ JWT Token (存储在 localStorage)     │
└─────────────┬───────────────────────────┘
              │ HTTP
              ▼
┌─────────────────────────────────────────┐
│  Express API Server                     │
│  ├─ authenticateToken 中间件            │
│  ├─ 验证 JWT 签名                       │
│  ├─ 解析 userId                         │
│  └─ 检查路由权限                        │
└─────────────┬───────────────────────────┘
              │
              ▼
┌─────────────────────────────────────────┐
│  MySQL/OceanBase                        │
│  ├─ 应用层过滤                          │
│  ├─ WHERE user_id = ?                   │
│  └─ 参数化查询防 SQL 注入               │
└─────────────────────────────────────────┘
```

**特点**：
- JWT Secret 必须保密
- API 层控制权限
- 需要手动实现安全检查

---

## 💰 成本对比

### Supabase 成本

```
免费版：
├─ 数据库: 500 MB
├─ 存储: 1 GB
├─ 带宽: 2 GB/月
├─ API 请求: 无限制（有速率限制）
└─ 适合: 开发、小型项目

专业版 $25/月：
├─ 数据库: 8 GB
├─ 存储: 100 GB
├─ 带宽: 50 GB/月
├─ 无速率限制
└─ 适合: 生产环境

企业版 自定义：
├─ 专属资源
├─ SLA 保障
└─ 技术支持
```

---

### Custom 成本

```
开发环境（本地）：
├─ 硬件: $0（使用现有电脑）
├─ 软件: $0（MySQL 开源）
└─ 总计: $0

生产环境（服务器）：
├─ 服务器: $100-500/月（云服务器）
│   或 一次性硬件成本
├─ 数据库: $0（MySQL 开源）
│   或 OceanBase 企业版（咨询）
├─ 运维: 人力成本
└─ 总计: 取决于规模
```

---

## 🚀 性能优化建议

### Supabase 优化

```
1. 区域选择
   ┌─────────────────────────────┐
   │ 选择最近的数据中心           │
   │ • ap-northeast-1 (东京)     │
   │ • ap-southeast-1 (新加坡)   │
   └─────────────────────────────┘

2. 查询优化
   ┌─────────────────────────────┐
   │ • 只选择需要的字段           │
   │ • 使用索引字段排序           │
   │ • 添加适当的 limit           │
   └─────────────────────────────┘

3. 实时订阅
   ┌─────────────────────────────┐
   │ • 只订阅必要的表             │
   │ • 使用过滤条件减少事件       │
   └─────────────────────────────┘
```

---

### Custom 优化

```
1. 连接池配置
   ┌─────────────────────────────┐
   │ connectionLimit: 10-50      │
   │ queueLimit: 0               │
   │ waitForConnections: true    │
   └─────────────────────────────┘

2. 数据库索引
   ┌─────────────────────────────┐
   │ CREATE INDEX idx_user_id    │
   │ ON workflows(user_id)       │
   └─────────────────────────────┘

3. 查询缓存
   ┌─────────────────────────────┐
   │ • 使用 Redis 缓存热点数据   │
   │ • 设置合理的过期时间         │
   └─────────────────────────────┘
```

---

## 🎓 学习路径

### 初学者路径

```
第 1 天: 基础理解
├─ 阅读 QUICKSTART_DUAL_ENGINE.md
├─ 理解双引擎概念
└─ 尝试切换引擎

第 2 天: Supabase 实践
├─ 使用 Supabase 开发
├─ 理解服务接口
└─ 创建测试数据

第 3 天: Custom 实践
├─ 启动 API 服务器
├─ 连接本地数据库
└─ 对比两个引擎

第 4-5 天: 深入理解
├─ 阅读 ARCHITECTURE_DUAL_ENGINE.md
├─ 理解实现原理
└─ 尝试扩展功能
```

---

### 开发者路径

```
第 1 天: 架构理解
├─ 阅读所有文档
├─ 研究代码实现
└─ 理解设计模式

第 2 天: 接口设计
├─ 理解服务接口
├─ 学习工厂模式
└─ 研究依赖注入

第 3 天: 实现分析
├─ Supabase SDK 使用
├─ Express API 设计
└─ 数据库操作

第 4-5 天: 扩展开发
├─ 添加新功能
├─ 优化性能
└─ 实现新引擎（可选）
```

---

**这份可视化指南帮助您直观理解双引擎架构！**

更新时间：2024-01-18
