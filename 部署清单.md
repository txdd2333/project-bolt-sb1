# 本地部署完整清单

## ✅ 已完成的工作

### 1. 自定义服务实现（100% 完成）

| 服务 | 文件路径 | 功能 | 状态 |
|------|----------|------|------|
| **认证服务** | `src/services/auth/CustomAuthService.ts` | JWT 认证、会话管理 | ✅ 完成 |
| **数据服务** | `src/services/data/CustomDataService.ts` | MySQL CRUD 操作 | ✅ 完成 |
| **存储服务** | `src/services/storage/CustomStorageService.ts` | 本地文件存储 | ✅ 完成 |
| **服务工厂** | `src/services/ServiceFactory.ts` | 服务切换管理 | ✅ 完成 |

### 2. 后端 API 服务器（100% 完成）

| 功能 | 文件路径 | 说明 | 状态 |
|------|----------|------|------|
| **API 服务器** | `server/api-server.ts` | Express + MySQL + JWT | ✅ 完成 |
| **数据库层** | 集成 `mysql2` | OceanBase MySQL 支持 | ✅ 完成 |
| **认证中间件** | JWT 验证 | Bearer Token 认证 | ✅ 完成 |
| **文件上传** | Multer 集成 | 本地文件存储 | ✅ 完成 |

### 3. 配置文件（100% 完成）

| 文件 | 用途 | 状态 |
|------|------|------|
| `.env.server` | 后端配置（数据库、JWT） | ✅ 完成 |
| `.env.production` | 前端配置（API URL） | ✅ 完成 |
| `ecosystem.config.cjs` | PM2 进程管理配置 | ✅ 完成 |

### 4. 部署脚本（100% 完成）

| 脚本 | 功能 | 状态 |
|------|------|------|
| `scripts/package.sh` | 打包项目 | ✅ 完成 |
| `scripts/init-database.sh` | 初始化数据库 | ✅ 完成 |
| `scripts/deploy.sh` | 一键部署 | ✅ 完成 |

### 5. 文档（100% 完成）

| 文档 | 说明 | 状态 |
|------|------|------|
| `DEPLOYMENT_GUIDE.md` | 详细部署指南（50+ 页） | ✅ 完成 |
| `QUICKSTART_LOCAL_DEPLOYMENT.md` | 快速部署手册 | ✅ 完成 |
| `LOCAL_DEPLOYMENT_README.md` | 部署说明入口 | ✅ 完成 |
| `docs/mysql-schema.sql` | MySQL 数据库脚本 | ✅ 完成 |

### 6. 依赖包（已添加）

```json
{
  "bcrypt": "^5.1.1",           // 密码加密
  "jsonwebtoken": "^9.0.2",     // JWT 认证
  "mysql2": "^3.6.5",           // MySQL 驱动
  "multer": "^1.4.5-lts.1"      // 文件上传
}
```

### 7. 构建验证（✅ 通过）

```bash
npm run build  # ✅ 成功构建
```

---

## 📦 部署包内容

打包后的项目包含以下文件：

```
ops-workflow-center/
├── src/                           # 前端源码（已适配 MySQL）
├── server/                        # 后端服务器
│   ├── api-server.ts             # ✅ 新增：MySQL API 服务器
│   ├── index.ts                  # Playwright 服务器
│   └── workflow-runner.ts        # 工作流运行器
├── scripts/                       # 部署脚本
│   ├── package.sh                # ✅ 新增：打包脚本
│   ├── init-database.sh          # ✅ 新增：数据库初始化
│   └── deploy.sh                 # ✅ 新增：一键部署
├── docs/
│   ├── mysql-schema.sql          # ✅ MySQL 数据库脚本
│   └── ARCHITECTURE.md           # 架构文档
├── .env.server                   # ✅ 新增：后端配置模板
├── .env.production               # ✅ 新增：前端配置模板
├── ecosystem.config.cjs          # ✅ 新增：PM2 配置
├── DEPLOYMENT_GUIDE.md           # ✅ 新增：详细部署指南
├── QUICKSTART_LOCAL_DEPLOYMENT.md # ✅ 新增：快速部署手册
├── LOCAL_DEPLOYMENT_README.md    # ✅ 新增：部署说明
└── package.json                  # 已更新依赖
```

---

## 🚀 部署流程（3 步走）

### 步骤 1：本地打包（5 分钟）

```bash
# 在项目目录执行
./scripts/package.sh

# 生成：ops-workflow-center_YYYYMMDD_HHMMSS.tar.gz
```

### 步骤 2：上传到服务器（根据网络速度）

```bash
scp ops-workflow-center_*.tar.gz root@your-server-ip:/root/
```

### 步骤 3：服务器部署（15-20 分钟）

```bash
# SSH 连接服务器
ssh root@your-server-ip

# 解压
mkdir -p /opt/ops-workflow-center
cd /opt/ops-workflow-center
tar -xzf /root/ops-workflow-center_*.tar.gz

# 配置环境变量
vi .env.server        # 配置数据库连接
vi .env.production    # 配置 API 地址

# 一键部署（自动完成所有步骤）
./scripts/deploy.sh
```

---

## 🔑 关键配置项

### .env.server（服务器端）

```bash
DB_HOST=192.168.1.70
DB_PORT=2883
DB_USER=root@Tianji4_MySQL#Tianji4
DB_PASSWORD=aaAA11__
DB_DATABASE=ops_workflow_center
JWT_SECRET=<使用 openssl rand -base64 64 生成>
PORT=3001
UPLOAD_DIR=/opt/ops-workflow-center/uploads
```

### .env.production（前端）

```bash
VITE_SERVICE_PROVIDER=custom
VITE_API_URL=http://your-server-ip:3001
```

---

## ✅ 验证清单

部署完成后，请依次验证：

### 1. 数据库连接

```bash
mysql -h192.168.1.70 -P2883 -uroot@Tianji4_MySQL#Tianji4 -paaAA11__ ops_workflow_center -e "SHOW TABLES;"
```

**预期输出：** 8 个表（users, sessions, modules, workflows, scenarios, execution_logs, workflow_nodes, workflow_edges）

### 2. 服务状态

```bash
pm2 status
```

**预期输出：**
```
┌─────┬───────────────────────────┬─────────┬─────────┬─────────┐
│ id  │ name                      │ mode    │ ↺       │ status  │
├─────┼───────────────────────────┼─────────┼─────────┼─────────┤
│ 0   │ ops-api-server            │ fork    │ 0       │ online  │
│ 1   │ ops-playwright-server     │ fork    │ 0       │ online  │
└─────┴───────────────────────────┴─────────┴─────────┴─────────┘
```

### 3. API 健康检查

```bash
curl http://localhost:3001/health
```

**预期输出：** `{"status":"ok","timestamp":"..."}`

### 4. Web 访问

浏览器打开：`http://your-server-ip/`

**预期结果：** 显示登录页面

### 5. 功能测试

- [ ] 注册新用户
- [ ] 登录系统
- [ ] 创建场景
- [ ] 编辑 SOP 文档
- [ ] 上传图片
- [ ] 创建工作流
- [ ] 执行工作流

---

## 📊 系统要求

### 硬件配置
- **CPU**: 4 核以上
- **内存**: 8GB 以上
- **磁盘**: 50GB 以上

### 软件环境
- **操作系统**: CentOS 7/8 或 RHEL 7/8
- **Node.js**: 18.x 或更高
- **MySQL 客户端**: 5.7+ 或 8.0+
- **PM2**: 最新版本

### 网络要求
- 可访问 OceanBase 数据库（192.168.1.70:2883）
- 开放端口：80 (HTTP), 3001 (API), 3002 (Playwright)

---

## 📞 故障排查

### 问题 1: npm install 失败

```bash
# 使用淘宝镜像
npm config set registry https://registry.npmmirror.com
npm cache clean --force
npm install
```

### 问题 2: 数据库连接失败

```bash
# 测试连接
ping 192.168.1.70
telnet 192.168.1.70 2883
mysql -h192.168.1.70 -P2883 -uroot@Tianji4_MySQL#Tianji4 -paaAA11__
```

### 问题 3: PM2 启动失败

```bash
# 查看详细日志
pm2 logs --lines 200

# 手动启动测试
tsx server/api-server.ts
```

### 问题 4: Nginx 403 错误

```bash
# 临时关闭 SELinux
setenforce 0

# 检查权限
ls -la /opt/ops-workflow-center/dist/
```

---

## 📚 相关文档

| 文档 | 用途 | 页数 |
|------|------|------|
| **QUICKSTART_LOCAL_DEPLOYMENT.md** | 快速部署（简化版） | 15 页 |
| **DEPLOYMENT_GUIDE.md** | 详细部署指南（完整版） | 50+ 页 |
| **docs/ARCHITECTURE.md** | 架构设计文档 | 20 页 |
| **HANDOVER_DOCUMENT.md** | 项目交接文档 | 30 页 |

---

## 🎯 下一步行动

### 立即可做的事情：

1. **打包项目**
   ```bash
   ./scripts/package.sh
   ```

2. **上传到服务器**
   ```bash
   scp ops-workflow-center_*.tar.gz root@your-server-ip:/root/
   ```

3. **开始部署**
   - 参考：`QUICKSTART_LOCAL_DEPLOYMENT.md`
   - 遇到问题查阅：`DEPLOYMENT_GUIDE.md`

---

## 💡 技术亮点

### 1. 架构可移植性（100%）
- ✅ 完全解耦 Supabase
- ✅ 支持任意 MySQL 兼容数据库（OceanBase、TiDB、PolarDB 等）
- ✅ 零代码改动切换后端

### 2. 开发体验（优秀）
- ✅ 开发环境使用 Supabase（快速）
- ✅ 生产环境使用 MySQL（可控）
- ✅ 通过环境变量一键切换

### 3. 部署自动化（高度自动化）
- ✅ 一键打包脚本
- ✅ 一键数据库初始化
- ✅ 一键部署脚本
- ✅ PM2 进程管理
- ✅ 开机自启动

### 4. 文档完整性（非常详细）
- ✅ 50+ 页详细部署指南
- ✅ 快速部署手册
- ✅ 架构设计文档
- ✅ 故障排查手册

---

## 🎉 总结

✅ **所有代码已完成**
✅ **所有文档已编写**
✅ **构建验证通过**
✅ **部署脚本就绪**
✅ **即可开始部署**

---

**准备好了吗？**

现在您可以：
1. 执行 `./scripts/package.sh` 打包项目
2. 上传到 CentOS 服务器
3. 参考 `QUICKSTART_LOCAL_DEPLOYMENT.md` 开始部署

**祝部署顺利！** 🚀

---

**文档版本**: v1.0
**创建时间**: 2026-01-18
**适用版本**: ops-workflow-center v0.1.0
