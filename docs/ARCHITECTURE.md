# è¿ç»´å·¥ä½œæµä¸­å¿ƒ - å¯ç§»æ¤æ¶æ„è®¾è®¡æ–‡æ¡£

## ğŸ“ æ¶æ„æ¦‚è§ˆ

æœ¬é¡¹ç›®å·²å®Œæˆä» **Supabase æ·±åº¦è€¦åˆ** åˆ° **æœåŠ¡æŠ½è±¡å±‚æ¶æ„** çš„é‡æ„ï¼Œå®ç°äº†**100% å¯ç§»æ¤æ€§**ã€‚

### æ¶æ„åˆ†å±‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  UI å±‚ (React Components)                                â”‚
â”‚  - Pages: WorkflowsPage, ScenariosPage, etc.           â”‚
â”‚  - Components: MarkdownEditor, ReactFlowEditor          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ ä½¿ç”¨æ¥å£
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æŠ½è±¡å±‚ (Service Interfaces)                            â”‚
â”‚  - IAuthService:     è®¤è¯æœåŠ¡æ¥å£                        â”‚
â”‚  - IDataService:     æ•°æ®æœåŠ¡æ¥å£                        â”‚
â”‚  - IStorageService:  å­˜å‚¨æœåŠ¡æ¥å£                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ å®ç°
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æœåŠ¡å·¥å‚ (ServiceFactory)                              â”‚
â”‚  - æ ¹æ®ç¯å¢ƒå˜é‡é€‰æ‹©å®ç°                                  â”‚
â”‚  - VITE_SERVICE_PROVIDER: 'supabase' | 'custom'        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Supabase å®ç°  â”‚       â”‚  è‡ªå®šä¹‰å®ç°      â”‚
â”‚ (å¼€å‘ç¯å¢ƒ)      â”‚       â”‚  (ç”Ÿäº§ç¯å¢ƒ)      â”‚
â”‚                â”‚       â”‚                  â”‚
â”‚ - Supabase     â”‚       â”‚ - OceanBase     â”‚
â”‚ - PostgreSQL   â”‚       â”‚ - MySQL         â”‚
â”‚ - Auth         â”‚       â”‚ - JWT           â”‚
â”‚ - Storage      â”‚       â”‚ - MinIO         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ æ ¸å¿ƒè®¾è®¡åŸåˆ™

### 1. æ¥å£ä¼˜å…ˆ (Interface-First)

æ‰€æœ‰æœåŠ¡é€šè¿‡ç»Ÿä¸€æ¥å£å®šä¹‰ï¼Œä¸šåŠ¡ä»£ç åªä¾èµ–æ¥å£ï¼š

```typescript
// æ¥å£å®šä¹‰
export interface IAuthService {
  signIn(email: string, password: string): Promise<AuthResult>
  signUp(email: string, password: string): Promise<AuthResult>
  signOut(): Promise<void>
  getSession(): Promise<Session | null>
  onAuthStateChange(callback): Unsubscribe
}

// ä¸šåŠ¡ä»£ç ä½¿ç”¨
import { authService } from '@/services'
await authService.signIn(email, password)
```

### 2. ä¾èµ–æ³¨å…¥ (Dependency Injection)

é€šè¿‡å·¥å‚æ¨¡å¼ç»Ÿä¸€ç®¡ç†æœåŠ¡å®ä¾‹ï¼š

```typescript
// ServiceFactory.ts
static getAuthService(): IAuthService {
  const provider = import.meta.env.VITE_SERVICE_PROVIDER

  switch (provider) {
    case 'supabase':
      return new SupabaseAuthService()
    case 'custom':
      return new CustomAuthService()
  }
}
```

### 3. é…ç½®é©±åŠ¨ (Configuration-Driven)

é€šè¿‡ç¯å¢ƒå˜é‡åˆ‡æ¢ä¸åŒå®ç°ï¼Œé›¶ä»£ç æ”¹åŠ¨ï¼š

```bash
# å¼€å‘ç¯å¢ƒ (.env)
VITE_SERVICE_PROVIDER=supabase
VITE_SUPABASE_URL=https://xxx.supabase.co
VITE_SUPABASE_ANON_KEY=xxx

# ç”Ÿäº§ç¯å¢ƒ (.env.production)
VITE_SERVICE_PROVIDER=custom
VITE_API_URL=https://api.example.com
VITE_API_KEY=xxx
```

---

## ğŸ“ é¡¹ç›®ç»“æ„

```
src/
â”œâ”€â”€ services/                    # æœåŠ¡æŠ½è±¡å±‚
â”‚   â”œâ”€â”€ types.ts                 # é€šç”¨ç±»å‹å®šä¹‰
â”‚   â”œâ”€â”€ ServiceFactory.ts        # æœåŠ¡å·¥å‚
â”‚   â”œâ”€â”€ index.ts                 # ç»Ÿä¸€å¯¼å‡º
â”‚   â”œâ”€â”€ auth/                    # è®¤è¯æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ IAuthService.ts      # æ¥å£å®šä¹‰
â”‚   â”‚   â””â”€â”€ SupabaseAuthService.ts  # Supabase å®ç°
â”‚   â”œâ”€â”€ data/                    # æ•°æ®æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ IDataService.ts      # æ¥å£å®šä¹‰
â”‚   â”‚   â””â”€â”€ SupabaseDataService.ts  # Supabase å®ç°
â”‚   â””â”€â”€ storage/                 # å­˜å‚¨æœåŠ¡
â”‚       â”œâ”€â”€ IStorageService.ts   # æ¥å£å®šä¹‰
â”‚       â””â”€â”€ SupabaseStorageService.ts  # Supabase å®ç°
â”œâ”€â”€ pages/                       # é¡µé¢ç»„ä»¶ï¼ˆå·²é‡æ„ï¼‰
â”‚   â”œâ”€â”€ WorkflowsPage.tsx       # âœ… ä½¿ç”¨ dataService
â”‚   â”œâ”€â”€ ScenariosPage.tsx       # âœ… ä½¿ç”¨ dataService
â”‚   â”œâ”€â”€ ExecutionLogsPage.tsx   # âœ… ä½¿ç”¨ dataService
â”‚   â”œâ”€â”€ ModulesPage.tsx         # âœ… ä½¿ç”¨ dataService
â”‚   â””â”€â”€ ...
â”œâ”€â”€ components/                  # ç»„ä»¶ï¼ˆå·²é‡æ„ï¼‰
â”‚   â”œâ”€â”€ MarkdownEditor.tsx      # âœ… ä½¿ç”¨ authService + storageService
â”‚   â””â”€â”€ ...
â””â”€â”€ contexts/                    # ä¸Šä¸‹æ–‡ï¼ˆå·²é‡æ„ï¼‰
    â””â”€â”€ AuthContext.tsx         # âœ… ä½¿ç”¨ authService
```

---

## ğŸ”„ é‡æ„æ¸…å•

### âœ… å·²å®Œæˆ

| æ¨¡å— | é‡æ„å†…å®¹ | çŠ¶æ€ |
|------|---------|------|
| **æœåŠ¡æ¥å£** | åˆ›å»º IAuthServiceã€IDataServiceã€IStorageService | âœ… |
| **Supabase é€‚é…å™¨** | å®ç° SupabaseAuthServiceã€SupabaseDataServiceã€SupabaseStorageService | âœ… |
| **æœåŠ¡å·¥å‚** | ServiceFactory + é…ç½®ç®¡ç† | âœ… |
| **AuthContext** | é‡æ„ä¸ºä½¿ç”¨ authService | âœ… |
| **é¡µé¢ç»„ä»¶** | WorkflowsPageã€ScenariosPageã€ExecutionLogsPageã€ModulesPage ç­‰ | âœ… |
| **å…¶ä»–ç»„ä»¶** | MarkdownEditorã€ScenarioDetailPageã€WorkflowEditorPage | âœ… |
| **MySQL Schema** | åˆ›å»º MySQL 8.0+ å…¼å®¹çš„æ•°æ®åº“è„šæœ¬ | âœ… |
| **æ„å»ºéªŒè¯** | npm run build æˆåŠŸ | âœ… |

### â³ å¾…å®ç°ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰

| æ¨¡å— | å®ç°å†…å®¹ | ä¼˜å…ˆçº§ |
|------|---------|-------|
| **CustomAuthService** | åŸºäº JWT çš„è®¤è¯æœåŠ¡ | P0 |
| **CustomDataService** | åŸºäº REST API + MySQL çš„æ•°æ®æœåŠ¡ | P0 |
| **CustomStorageService** | åŸºäº MinIO æˆ–æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿçš„å­˜å‚¨æœåŠ¡ | P1 |
| **åç«¯ API** | Node.js + Express + MySQL | P0 |
| **æ•°æ®è¿ç§»è„šæœ¬** | PostgreSQL â†’ MySQL æ•°æ®è¿ç§» | P1 |

---

## ğŸ”Œ æ¥å£å®šä¹‰

### IAuthService (è®¤è¯æœåŠ¡)

```typescript
interface IAuthService {
  // ç™»å½•
  signIn(email: string, password: string): Promise<AuthResult>

  // æ³¨å†Œ
  signUp(email: string, password: string): Promise<AuthResult>

  // ç™»å‡º
  signOut(): Promise<void>

  // è·å–å½“å‰ä¼šè¯
  getSession(): Promise<Session | null>

  // è·å–å½“å‰ç”¨æˆ·
  getCurrentUser(): Promise<User | null>

  // ç›‘å¬è®¤è¯çŠ¶æ€å˜åŒ–
  onAuthStateChange(callback: (session: Session | null) => void): Unsubscribe
}
```

### IDataService (æ•°æ®æœåŠ¡)

```typescript
interface IDataService {
  // æŸ¥è¯¢å¤šæ¡è®°å½•
  query<T>(table: string, options?: QueryOptions): Promise<QueryArrayResult<T>>

  // æŸ¥è¯¢å•æ¡è®°å½•
  queryOne<T>(table: string, options?: QueryOptions): Promise<QueryResult<T>>

  // æ’å…¥è®°å½•
  insert<T>(table: string, data: Partial<T> | Partial<T>[]): Promise<QueryResult<T> | QueryArrayResult<T>>

  // æ›´æ–°è®°å½•
  update<T>(table: string, id: string, data: Partial<T>): Promise<QueryResult<T>>

  // åˆ é™¤è®°å½•
  delete(table: string, id: string): Promise<{ error: Error | null }>

  // å®æ—¶è®¢é˜…
  subscribe(table: string, callback: (event: string, payload: any) => void): () => void
}
```

### IStorageService (å­˜å‚¨æœåŠ¡)

```typescript
interface IStorageService {
  // ä¸Šä¼ æ–‡ä»¶
  upload(bucket: string, path: string, file: File | Blob): Promise<UploadResult>

  // ä¸‹è½½æ–‡ä»¶
  download(bucket: string, path: string): Promise<Blob | null>

  // åˆ é™¤æ–‡ä»¶
  delete(bucket: string, path: string): Promise<{ error: Error | null }>

  // è·å–å…¬å¼€URL
  getPublicUrl(bucket: string, path: string): string

  // åˆ—å‡ºæ–‡ä»¶
  list(bucket: string, path?: string): Promise<{ data: any[] | null; error: Error | null }>
}
```

---

## ğŸ› ï¸ ä½¿ç”¨æŒ‡å—

### å¼€å‘é˜¶æ®µï¼ˆå½“å‰ï¼‰

ä½¿ç”¨ Supabase è¿›è¡Œå¼€å‘ï¼š

```bash
# .env
VITE_SERVICE_PROVIDER=supabase
VITE_SUPABASE_URL=https://xxx.supabase.co
VITE_SUPABASE_ANON_KEY=your-anon-key

# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
npm run dev
```

### ç”Ÿäº§ç¯å¢ƒï¼ˆåˆ‡æ¢åç«¯ï¼‰

1. **å®ç°è‡ªå®šä¹‰æœåŠ¡**

```typescript
// src/services/auth/CustomAuthService.ts
export class CustomAuthService implements IAuthService {
  async signIn(email: string, password: string): Promise<AuthResult> {
    const response = await fetch('/api/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password })
    })
    const data = await response.json()
    return { user: data.user, session: data.session, error: null }
  }
  // ... å…¶ä»–æ–¹æ³•å®ç°
}
```

2. **æ›´æ–°æœåŠ¡å·¥å‚**

```typescript
// src/services/ServiceFactory.ts
case 'custom':
  this.authServiceInstance = new CustomAuthService()
  break
```

3. **ä¿®æ”¹ç¯å¢ƒå˜é‡**

```bash
# .env.production
VITE_SERVICE_PROVIDER=custom
VITE_API_URL=https://api.example.com
VITE_API_KEY=your-api-key
```

4. **é›¶ä»£ç æ”¹åŠ¨**

å‰ç«¯ä¸šåŠ¡ä»£ç æ— éœ€ä¿®æ”¹ï¼Œç›´æ¥æ„å»ºéƒ¨ç½²ï¼š

```bash
npm run build
```

---

## ğŸ“Š æ•°æ®åº“å…¼å®¹æ€§

### PostgreSQL â†’ MySQL æ˜ å°„

| PostgreSQL | MySQL 8.0+ | è¯´æ˜ |
|------------|-----------|------|
| `uuid` | `CHAR(36)` | UUID å­—ç¬¦ä¸²æ ¼å¼ |
| `jsonb` | `JSON` | MySQL åŸç”Ÿ JSON ç±»å‹ |
| `timestamptz` | `DATETIME` | æ—¶é—´æˆ³ |
| `gen_random_uuid()` | åº”ç”¨å±‚ç”Ÿæˆ | ä½¿ç”¨ `crypto.randomUUID()` |
| `now()` | `CURRENT_TIMESTAMP` | å½“å‰æ—¶é—´ |
| RLS ç­–ç•¥ | åº”ç”¨å±‚æ§åˆ¶ | WHERE user_id = ? |

å®Œæ•´ MySQL Schema è§ï¼š`docs/mysql-schema.sql`

---

## ğŸš€ è¿ç§»è·¯å¾„

### é˜¶æ®µ 1ï¼šæŠ½è±¡å±‚å¼€å‘ âœ… (å·²å®Œæˆ)

- âœ… åˆ›å»ºæœåŠ¡æ¥å£å®šä¹‰
- âœ… å®ç° Supabase é€‚é…å™¨
- âœ… é‡æ„æ‰€æœ‰ä¸šåŠ¡ä»£ç 
- âœ… éªŒè¯æ„å»ºæˆåŠŸ

### é˜¶æ®µ 2ï¼šåç«¯æœåŠ¡å¼€å‘ (1-2 å‘¨)

- [ ] å®ç° Node.js REST API
- [ ] å®ç° JWT è®¤è¯
- [ ] å®ç°æ•°æ® CRUD
- [ ] å®ç°æ–‡ä»¶ä¸Šä¼ 

### é˜¶æ®µ 3ï¼šç”Ÿäº§éƒ¨ç½² (1 å‘¨)

- [ ] éƒ¨ç½² OceanBase/MySQL
- [ ] éƒ¨ç½²åç«¯æœåŠ¡
- [ ] æ•°æ®è¿ç§»
- [ ] ç¯å¢ƒå˜é‡åˆ‡æ¢
- [ ] å…¨é‡æµ‹è¯•

---

## ğŸ¯ ä¼˜åŠ¿æ€»ç»“

### âœ… æŠ€æœ¯ç‹¬ç«‹æ€§

- ä¸ä¾èµ–ä»»ä½•ç‰¹å®šäº‘æœåŠ¡å•†
- é¿å…ä¾›åº”å•†é”å®š
- éšæ—¶å¯åˆ‡æ¢åç«¯

### âœ… æˆæœ¬ä¼˜åŒ–

- Supabase æ”¶è´¹ vs è‡ªæ‰˜ç®¡å…è´¹
- å¯æ ¹æ®éœ€æ±‚é€‰æ‹©æœ€ä¼˜æ–¹æ¡ˆ

### âœ… æ•°æ®å®‰å…¨

- æ•æ„Ÿæ•°æ®å¯ç•™åœ¨æœ¬åœ°
- ç¬¦åˆæ•°æ®åˆè§„è¦æ±‚

### âœ… æ€§èƒ½å¯æ§

- OceanBase é«˜æ€§èƒ½
- å¯é’ˆå¯¹æ€§ä¼˜åŒ–æŸ¥è¯¢

### âœ… æ‰©å±•æ€§å¼º

- æ”¯æŒå¤šç§æ•°æ®åº“ï¼ˆTiDBã€PostgreSQLï¼‰
- æ”¯æŒå¤šç§å­˜å‚¨æ–¹æ¡ˆï¼ˆS3ã€MinIOã€æœ¬åœ°ï¼‰

---

## ğŸ“ æœ€ä½³å®è·µ

### 1. ä¸šåŠ¡ä»£ç è§„èŒƒ

```typescript
// âœ… æ­£ç¡®ï¼šä½¿ç”¨æŠ½è±¡å±‚
import { dataService } from '@/services'
const { data } = await dataService.query<Workflow>('workflows')

// âŒ é”™è¯¯ï¼šç›´æ¥ä½¿ç”¨ Supabase
import { supabase } from '@/lib/supabase'
const { data } = await supabase.from('workflows').select('*')
```

### 2. é”™è¯¯å¤„ç†

```typescript
const { data, error } = await dataService.query('workflows')

if (error) {
  console.error('Query failed:', error)
  return
}

// ä½¿ç”¨ data
```

### 3. TypeScript ç±»å‹

```typescript
// ä½¿ç”¨æ³›å‹ä¿æŒç±»å‹å®‰å…¨
const { data } = await dataService.query<Workflow>('workflows')
// data ç±»å‹ä¸º Workflow[]
```

---

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜ï¼šæœåŠ¡å·¥å‚è¿”å›é”™è¯¯

**æ£€æŸ¥ç¯å¢ƒå˜é‡**
```bash
echo $VITE_SERVICE_PROVIDER
# åº”è¯¥è¾“å‡º: supabase æˆ– custom
```

### é—®é¢˜ï¼šç±»å‹é”™è¯¯

**ç¡®è®¤å¯¼å…¥æ­£ç¡®**
```typescript
import { dataService } from '@/services'  // âœ…
import { supabase } from '@/lib/supabase'  // âŒ
```

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

- æ¶æ„é—®é¢˜ï¼šå‚è€ƒæœ¬æ–‡æ¡£
- Supabase é—®é¢˜ï¼šhttps://supabase.com/docs
- TypeScript é—®é¢˜ï¼šhttps://www.typescriptlang.org/docs

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2026-01-18
**æ¶æ„å¸ˆ**: Claude (Anthropic)
