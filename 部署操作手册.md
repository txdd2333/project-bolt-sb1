# Docker éƒ¨ç½²æ“ä½œæ‰‹å†Œ

## ğŸ“‹ éƒ¨ç½²æ­¥éª¤ï¼ˆæŒ‰é¡ºåºæ‰§è¡Œï¼‰

### ç¬¬ä¸€æ­¥ï¼šæ‰“åŒ…é¡¹ç›®

åœ¨ä½ çš„æœ¬åœ°ç”µè„‘æˆ–å¼€å‘æœºå™¨ä¸Šæ‰§è¡Œï¼š

```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd ops-workflow-center

# æ‰§è¡Œæ‰“åŒ…è„šæœ¬
bash pack-for-deploy.sh
```

æ‰§è¡Œå®Œæˆåä¼šç”Ÿæˆä¸€ä¸ª `.tar.gz` æ–‡ä»¶ï¼Œä¾‹å¦‚ï¼š
```
ops-workflow-center-20240118-143000.tar.gz
```

---

### ç¬¬äºŒæ­¥ï¼šä¸Šä¼ åˆ°æœåŠ¡å™¨

ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼š

```bash
# ä½¿ç”¨ SCP ä¸Šä¼ ï¼ˆæ›¿æ¢å®é™…çš„æ–‡ä»¶åå’ŒæœåŠ¡å™¨IPï¼‰
scp ops-workflow-center-20240118-143000.tar.gz root@ä½ çš„æœåŠ¡å™¨IP:/opt/
```

æˆ–è€…ä½¿ç”¨ FTP å·¥å…·ï¼ˆå¦‚ FileZillaï¼‰ä¸Šä¼ åˆ° `/opt/` ç›®å½•

---

### ç¬¬ä¸‰æ­¥ï¼šåœ¨æœåŠ¡å™¨ä¸Šè§£å‹

SSH ç™»å½•åˆ°æœåŠ¡å™¨ï¼Œç„¶åæ‰§è¡Œï¼š

```bash
# è¿›å…¥ç›®å½•
cd /opt

# è§£å‹æ–‡ä»¶ï¼ˆæ›¿æ¢å®é™…çš„æ–‡ä»¶åï¼‰
tar -xzf ops-workflow-center-20240118-143000.tar.gz

# è¿›å…¥é¡¹ç›®ç›®å½•
cd ops-workflow-center

# æŸ¥çœ‹æ–‡ä»¶
ls -la
```

---

### ç¬¬å››æ­¥ï¼šé…ç½®ç¯å¢ƒå˜é‡

```bash
# å¤åˆ¶ç¯å¢ƒå˜é‡æ¨¡æ¿
cp .env.example .env

# ç¼–è¾‘ç¯å¢ƒå˜é‡
vi .env
```

åœ¨ `.env` æ–‡ä»¶ä¸­å¡«å…¥ä½ çš„ Supabase é…ç½®ï¼š

```bash
VITE_SUPABASE_URL=https://ä½ çš„é¡¹ç›®.supabase.co
VITE_SUPABASE_ANON_KEY=ä½ çš„åŒ¿åå¯†é’¥
```

ä¿å­˜å¹¶é€€å‡ºï¼ˆvim ä¸­æŒ‰ `Esc`ï¼Œç„¶åè¾“å…¥ `:wq` å›è½¦ï¼‰

---

### ç¬¬äº”æ­¥ï¼šä¸€é”®éƒ¨ç½²

```bash
# æ‰§è¡Œéƒ¨ç½²è„šæœ¬
sudo bash docker-deploy.sh
```

è„šæœ¬ä¼šè‡ªåŠ¨å®Œæˆä»¥ä¸‹å·¥ä½œï¼š
1. âœ… æ£€æŸ¥å¹¶å®‰è£… Docker
2. âœ… æ£€æŸ¥å¹¶å®‰è£… Docker Compose
3. âœ… éªŒè¯ç¯å¢ƒé…ç½®
4. âœ… æ„å»º Docker é•œåƒï¼ˆé¦–æ¬¡éœ€è¦ 5-10 åˆ†é’Ÿï¼‰
5. âœ… å¯åŠ¨æœåŠ¡

---

### ç¬¬å…­æ­¥ï¼šé…ç½®é˜²ç«å¢™

```bash
# å¼€æ”¾å‰ç«¯ç«¯å£
sudo firewall-cmd --permanent --add-port=5173/tcp

# å¼€æ”¾åç«¯ç«¯å£
sudo firewall-cmd --permanent --add-port=3000/tcp

# é‡è½½é˜²ç«å¢™
sudo firewall-cmd --reload

# æŸ¥çœ‹å·²å¼€æ”¾çš„ç«¯å£
sudo firewall-cmd --list-ports
```

---

### ç¬¬ä¸ƒæ­¥ï¼šé…ç½®äº‘æœåŠ¡å™¨å®‰å…¨ç»„

å¦‚æœä½¿ç”¨é˜¿é‡Œäº‘/è…¾è®¯äº‘/AWS ç­‰äº‘æœåŠ¡å™¨ï¼š

1. ç™»å½•äº‘æœåŠ¡å™¨æ§åˆ¶å°
2. æ‰¾åˆ°"å®‰å…¨ç»„"æˆ–"é˜²ç«å¢™"è®¾ç½®
3. æ·»åŠ å…¥ç«™è§„åˆ™ï¼š
   - ç«¯å£ 5173ï¼Œåè®® TCPï¼Œæ¥æº 0.0.0.0/0
   - ç«¯å£ 3000ï¼Œåè®® TCPï¼Œæ¥æº 0.0.0.0/0
4. ä¿å­˜è§„åˆ™

---

### ç¬¬å…«æ­¥ï¼šéªŒè¯éƒ¨ç½²

```bash
# æ£€æŸ¥å®¹å™¨çŠ¶æ€
sudo docker-compose ps

# åº”è¯¥çœ‹åˆ°å®¹å™¨åœ¨è¿è¡Œï¼š
# NAME                    STATUS
# ops-workflow-center     Up 2 minutes

# æŸ¥çœ‹æ—¥å¿—
sudo docker-compose logs -f
```

---

### ç¬¬ä¹æ­¥ï¼šè®¿é—®åº”ç”¨

æ‰“å¼€æµè§ˆå™¨è®¿é—®ï¼š

- **å‰ç«¯é¡µé¢**: `http://ä½ çš„æœåŠ¡å™¨IP:5173`
- **åç«¯ API**: `http://ä½ çš„æœåŠ¡å™¨IP:3000/api/health`

çœ‹åˆ°é¡µé¢æ­£å¸¸æ˜¾ç¤ºå³è¡¨ç¤ºéƒ¨ç½²æˆåŠŸï¼

---

## ğŸ¯ å®Œæ•´å‘½ä»¤æ€»ç»“

### æœ¬åœ°æ“ä½œ

```bash
# 1. æ‰“åŒ…é¡¹ç›®
cd ops-workflow-center
bash pack-for-deploy.sh

# 2. ä¸Šä¼ åˆ°æœåŠ¡å™¨
scp ops-workflow-center-*.tar.gz root@æœåŠ¡å™¨IP:/opt/
```

### æœåŠ¡å™¨æ“ä½œ

```bash
# 3. è§£å‹é¡¹ç›®
cd /opt
tar -xzf ops-workflow-center-*.tar.gz
cd ops-workflow-center

# 4. é…ç½®ç¯å¢ƒ
cp .env.example .env
vi .env  # å¡«å…¥ Supabase é…ç½®

# 5. ä¸€é”®éƒ¨ç½²
sudo bash docker-deploy.sh

# 6. é…ç½®é˜²ç«å¢™
sudo firewall-cmd --permanent --add-port=5173/tcp
sudo firewall-cmd --permanent --add-port=3000/tcp
sudo firewall-cmd --reload

# 7. éªŒè¯éƒ¨ç½²
sudo docker-compose ps
sudo docker-compose logs -f
```

---

## ğŸ”§ å¸¸ç”¨ç®¡ç†å‘½ä»¤

### æŸ¥çœ‹æ—¥å¿—

```bash
# æŸ¥çœ‹å®æ—¶æ—¥å¿—
sudo docker-compose logs -f

# æŸ¥çœ‹ç‰¹å®šæœåŠ¡æ—¥å¿—
sudo docker-compose logs -f app

# æŸ¥çœ‹åº”ç”¨æ—¥å¿—æ–‡ä»¶
tail -f logs/api-out.log
tail -f logs/frontend-out.log
```

### æœåŠ¡æ§åˆ¶

```bash
# å¯åŠ¨æœåŠ¡
sudo docker-compose up -d

# åœæ­¢æœåŠ¡
sudo docker-compose down

# é‡å¯æœåŠ¡
sudo docker-compose restart

# æŸ¥çœ‹çŠ¶æ€
sudo docker-compose ps
```

### è¿›å…¥å®¹å™¨è°ƒè¯•

```bash
# è¿›å…¥å®¹å™¨å†…éƒ¨
sudo docker exec -it ops-workflow-center bash

# åœ¨å®¹å™¨å†…å¯ä»¥æ‰§è¡Œï¼š
node -v        # æŸ¥çœ‹ Node.js ç‰ˆæœ¬
npm -v         # æŸ¥çœ‹ npm ç‰ˆæœ¬
pm2 list       # æŸ¥çœ‹ PM2 è¿›ç¨‹
curl localhost:5173  # æµ‹è¯•å‰ç«¯
curl localhost:3000  # æµ‹è¯•åç«¯
exit           # é€€å‡ºå®¹å™¨
```

---

## âš ï¸ æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: å®¹å™¨æ— æ³•å¯åŠ¨

```bash
# æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯
sudo docker-compose logs

# æ£€æŸ¥ç¯å¢ƒå˜é‡æ˜¯å¦æ­£ç¡®
cat .env

# æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨
sudo netstat -tulpn | grep 5173
sudo netstat -tulpn | grep 3000
```

### é—®é¢˜ 2: æ— æ³•è®¿é—®æœåŠ¡

```bash
# æ£€æŸ¥å®¹å™¨æ˜¯å¦è¿è¡Œ
sudo docker ps

# æ£€æŸ¥é˜²ç«å¢™
sudo firewall-cmd --list-all

# æµ‹è¯•æœ¬åœ°è®¿é—®
curl http://localhost:5173
curl http://localhost:3000

# åœ¨å®¹å™¨å†…æµ‹è¯•
sudo docker exec -it ops-workflow-center curl http://localhost:5173
```

### é—®é¢˜ 3: æ„å»ºå¤±è´¥

```bash
# æ¸…ç†å¹¶é‡æ–°æ„å»º
sudo docker-compose down
sudo docker system prune -a  # æ¸…ç†æ‰€æœ‰æœªä½¿ç”¨çš„èµ„æº
sudo docker-compose build --no-cache
sudo docker-compose up -d
```

### é—®é¢˜ 4: å†…å­˜æˆ–ç£ç›˜ä¸è¶³

```bash
# æ£€æŸ¥ç£ç›˜ç©ºé—´
df -h

# æ£€æŸ¥å†…å­˜
free -h

# æ¸…ç† Docker èµ„æº
sudo docker system prune -a --volumes
```

---

## ğŸ”„ æ›´æ–°éƒ¨ç½²

å½“éœ€è¦æ›´æ–°ä»£ç æ—¶ï¼š

```bash
# 1. åœ¨æœ¬åœ°æ‰“åŒ…æ–°ç‰ˆæœ¬
bash pack-for-deploy.sh

# 2. ä¸Šä¼ åˆ°æœåŠ¡å™¨
scp ops-workflow-center-*.tar.gz root@æœåŠ¡å™¨IP:/opt/

# 3. åœ¨æœåŠ¡å™¨ä¸Šæ“ä½œ
cd /opt

# å¤‡ä»½å½“å‰ç‰ˆæœ¬
mv ops-workflow-center ops-workflow-center.backup

# è§£å‹æ–°ç‰ˆæœ¬
tar -xzf ops-workflow-center-*.tar.gz

# æ¢å¤ç¯å¢ƒé…ç½®å’Œæ•°æ®
cp ops-workflow-center.backup/.env ops-workflow-center/
cp -r ops-workflow-center.backup/logs ops-workflow-center/
cp -r ops-workflow-center.backup/uploads ops-workflow-center/

# é‡æ–°éƒ¨ç½²
cd ops-workflow-center
sudo docker-compose down
sudo docker-compose build
sudo docker-compose up -d
```

---

## ğŸ“Š æ€§èƒ½ç›‘æ§

### æŸ¥çœ‹èµ„æºä½¿ç”¨

```bash
# å®æ—¶æŸ¥çœ‹å®¹å™¨èµ„æºä½¿ç”¨
sudo docker stats ops-workflow-center

# æŸ¥çœ‹å®¹å™¨è¯¦ç»†ä¿¡æ¯
sudo docker inspect ops-workflow-center
```

### æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶å¤§å°

```bash
# æŸ¥çœ‹æ—¥å¿—ç›®å½•å¤§å°
du -sh logs/

# æ¸…ç†æ—§æ—¥å¿—ï¼ˆå¯é€‰ï¼‰
find logs/ -name "*.log" -mtime +7 -delete
```

---

## ğŸ” å®‰å…¨å»ºè®®

1. **ä¿®æ”¹é»˜è®¤ç«¯å£**: ç¼–è¾‘ `docker-compose.yml` å°† 5173 å’Œ 3000 æ”¹ä¸ºå…¶ä»–ç«¯å£
2. **é™åˆ¶è®¿é—®æ¥æº**: åœ¨é˜²ç«å¢™ä¸­åªå…è®¸ç‰¹å®š IP è®¿é—®
3. **å®šæœŸå¤‡ä»½**: æ¯å¤©å¤‡ä»½ `logs/` å’Œ `uploads/` ç›®å½•
4. **æ›´æ–°ç³»ç»Ÿ**: å®šæœŸæ‰§è¡Œ `yum update` æ›´æ–°ç³»ç»Ÿ
5. **ç›‘æ§æ—¥å¿—**: å®šæœŸæŸ¥çœ‹æ—¥å¿—å‘ç°å¼‚å¸¸

---

## ğŸ“¦ å¤‡ä»½æ–¹æ¡ˆ

### æ¯æ—¥å¤‡ä»½è„šæœ¬

åˆ›å»ºå¤‡ä»½è„šæœ¬ `/root/backup.sh`:

```bash
#!/bin/bash
BACKUP_DIR="/backup"
DATE=$(date +%Y%m%d)

mkdir -p $BACKUP_DIR

cd /opt/ops-workflow-center
tar -czf $BACKUP_DIR/ops-backup-$DATE.tar.gz logs uploads .env

# åªä¿ç•™æœ€è¿‘ 7 å¤©çš„å¤‡ä»½
find $BACKUP_DIR -name "ops-backup-*.tar.gz" -mtime +7 -delete

echo "å¤‡ä»½å®Œæˆ: $BACKUP_DIR/ops-backup-$DATE.tar.gz"
```

æ·»åŠ åˆ°å®šæ—¶ä»»åŠ¡ï¼š

```bash
# ç¼–è¾‘ crontab
crontab -e

# æ·»åŠ ä»¥ä¸‹è¡Œï¼ˆæ¯å¤©å‡Œæ™¨ 2 ç‚¹å¤‡ä»½ï¼‰
0 2 * * * /root/backup.sh
```

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

### æ–‡æ¡£ç´¢å¼•

- **å¿«é€Ÿå¼€å§‹**: DOCKER_QUICKSTART.md
- **è¯¦ç»†æ–‡æ¡£**: DOCKER_DEPLOYMENT.md
- **æ–¹æ¡ˆå¯¹æ¯”**: DEPLOYMENT_OPTIONS.md

### ç³»ç»Ÿè¦æ±‚

- **æ“ä½œç³»ç»Ÿ**: CentOS 7+, Rocky Linux 8+, Ubuntu 20.04+
- **å†…å­˜**: æœ€å°‘ 2GBï¼Œæ¨è 4GB
- **ç£ç›˜**: æœ€å°‘ 10GB å¯ç”¨ç©ºé—´
- **ç½‘ç»œ**: èƒ½è®¿é—® Docker Hub å’Œ Supabase

---

## âœ… éƒ¨ç½²æ£€æŸ¥æ¸…å•

å®Œæˆéƒ¨ç½²åï¼Œè¯·æ£€æŸ¥ä»¥ä¸‹é¡¹ç›®ï¼š

- [ ] å®¹å™¨æ­£å¸¸è¿è¡Œ (`sudo docker-compose ps`)
- [ ] å‰ç«¯é¡µé¢å¯ä»¥è®¿é—® (`http://æœåŠ¡å™¨IP:5173`)
- [ ] åç«¯ API å¯ä»¥è®¿é—® (`http://æœåŠ¡å™¨IP:3000`)
- [ ] é˜²ç«å¢™è§„åˆ™å·²é…ç½®
- [ ] äº‘æœåŠ¡å™¨å®‰å…¨ç»„å·²é…ç½®
- [ ] ç¯å¢ƒå˜é‡é…ç½®æ­£ç¡®
- [ ] æ—¥å¿—æ­£å¸¸è¾“å‡º (`sudo docker-compose logs -f`)
- [ ] å¯ä»¥æ­£å¸¸æ³¨å†Œå’Œç™»å½•
- [ ] Supabase æ•°æ®åº“è¿æ¥æ­£å¸¸

---

**ç¥éƒ¨ç½²é¡ºåˆ©ï¼**

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†æ–‡æ¡£æˆ–è”ç³»æŠ€æœ¯æ”¯æŒã€‚

---

æ›´æ–°æ—¶é—´: 2024-01-18
